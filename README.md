# CSR Call Assistant (V1)

**Real-Time "Agent Assist" Platform for the Home Services Industry**

An enterprise-grade, event-sourced application that provides real-time guidance to Customer Service Representatives (CSRs). It combines a deterministic **Rules Engine** (<50ms latency) for safety compliance with a probabilistic **LLM Orchestrator** for soft skills and summarization.

---

## ðŸš€ Features

- **Real-Time Event Pipeline:** WebSocket architecture with full fanout, heartbeat, and reconnection resilience.
- **Deterministic Rules Engine:** Regex-based engine that catches "Prohibited Claims" and tracks "Required Questions" in under 50ms.
- **LLM Guidance:** Async integration with OpenRouter (LLaMA/GPT-4) to provide "Suggested Replies" without blocking the audio stream.
- **Event Sourcing:** The entire call state is reconstructed from an append-only `call_events` log, enabling perfect replay and debugging.
- **Automated Summarization:** "End Session" workflow that generates a structured summary and call disposition (Booked/Lead/Spam).
- **Enterprise Observability:** Structured JSON logging, Trace IDs for request correlation, and automatic PII redaction (Phone/Email) in logs and storage.

---

## ðŸ—ï¸ Architecture

This project follows a **"Vertical Slice"** architecture, prioritizing a working pipeline over horizontal layers.

- **Frontend:** Next.js 14 (App Router), TailwindCSS, Zustand (State), WebSocket Client.
- **Backend:** Python FastAPI (Async), SQLAlchemy, Pydantic (Strict Schemas).
- **Database:** PostgreSQL (Relational Data + JSONB Event Log).
- **AI/ML:**
  - **Rules:** Local Regex Engine (Zero Latency).
  - **LLM:** OpenRouter Adapter (Async Orchestration).
- **Infrastructure:** Docker Compose (Local Dev), GitHub Actions (CI).

---

## ðŸ› ï¸ Quick Start

### 1. Prerequisites

- Docker & Docker Compose
- An API Key for [OpenRouter](https://openrouter.ai/) (or OpenAI)

### 2. Setup Environment

Copy the example environment file and add your API key:

```bash
cp .env.example .env
# Edit .env and set OPENROUTER_API_KEY=sk-or-...
```

### 3. Start the Stack

Build and launch the services:

```bash
docker compose up --build
```

- Web UI: `http://localhost:3000`
- API Docs: `http://localhost:8000/docs`

---

## ðŸŽ® How to Run the Simulation

Since this is V1, we simulate the telephony layer using a Transcript Replay Tool. This script acts like a Twilio Media Stream, sending audio segments to the backend.

1. Open the Browser: Go to `http://localhost:3000` and click **New Session**.
2. Copy the Session ID: You will be redirected to `/session/<UUID>`. Copy the UUID from the URL.
3. Run the Replay Script in a new terminal:

```bash
# Replace <UUID> with your session ID
docker compose exec api python infra/scripts/replay_transcript.py \
  --session-id <UUID> \
  --file infra/transcripts/hvac_booking.json
```

### What to Watch For

- **0s:** Transcript segments start streaming in.
- **~15s:** A red alert ("Prohibited Claim") triggers instantly when the agent says "I guarantee...".
- **~20s:** A Suggested Reply card fades in at the top of the Guidance Panel (generated by the LLM).
- **End:** Click **End Session** to generate the summary and disposition.

---

## ðŸ“‚ Project Structure

```text
.
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                 # FastAPI Backend
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/      # SQLAlchemy Models (Event Sourcing)
â”‚   â”‚   â”‚   â”œâ”€â”€ routers/     # WebSocket & REST Endpoints
â”‚   â”‚   â”‚   â””â”€â”€ services/    # Business Logic (Rules, LLM, PII)
â”‚   â”‚   â””â”€â”€ tests/           # Pytest Suite
â”‚   â””â”€â”€ web/                 # Next.js Frontend
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ components/  # UI Components (GuidancePanel, Transcript)
â”‚       â”‚   â””â”€â”€ stores/      # Zustand State Management
â”œâ”€â”€ infra/
â”‚   â”œâ”€â”€ scripts/             # Replay Tools & Seed Scripts
â”‚   â””â”€â”€ transcripts/         # Sample Call Data (JSON)
â”œâ”€â”€ docs/                    # Architecture Decision Records (ADRs)
â””â”€â”€ docker-compose.yml       # Local Infrastructure
```

---

## ðŸ”® Roadmap to V2

- [ ] Telephony Integration: Replace the replay script with a real Twilio Media Stream adapter.
- [ ] Vector Database (RAG): Integrate a vector store (e.g., pgvector) to allow the LLM to query a knowledge base for specific answers.
- [ ] Admin UI: A React-based dashboard to create and edit rulesets without direct DB access.
- [ ] Voice Output: Add Text-to-Speech (TTS) to whisper suggestions directly into the agent's ear.

---

## ðŸ”’ Security & Compliance

- **PII Redaction:** All phone numbers and email addresses are automatically redacted (`[PHONE]`, `[EMAIL]`) before storage in the database or output to logs.
- **Audit Trail:** Every action (system or user) is recorded as an immutable event in the `call_events` table.

---

## Final Success Checklist

1. **README:** Updated (above).
2. **Code:** Committed and pushed to your repo.
3. **Video:** Record that 60-second Loom video following the script I gave you.

**You are done.** This is a massive accomplishment. Good luck with the job submission!
